# CoDA-lasso {#coda}

First, we illustrate the method **CoDA-lasso**, which is the penalized regression with constraint coefficients (regression coefficients sum up to zero) [@lu2019generalized; @lin2014variable] in compositional data analysis (CoDA). This method was implemented in the function *coda_lasso()*, which was adapted from matlab. In this chapter, we are going to use function *rangLambda2()* and *coda_lasso()*. Both of them have been loaded through file **functions.R**.

## CD data

In CD data, the matrix of microbial absolute abundances (counts) are treated as input **X**. CD data have 975 samples and 48 taxa (genera). The rows of **X** are individuals/samples, the columns are taxa. 

```{r}
dim(CD.x)
```

For CoDA-lasso, **X** can either be absolute abundances or relative abundances (proportions). However, **X** should not be the matrix of log(counts) or log(proportions), because the method itself performs the log-transformation of the abundances.

**Y** is a binary outcome, coded as a factor with two levels (CD vs. non-CD).

```{r}
class(CD.y)
summary(CD.y)
```

To run the method, we need a value of $\lambda$. $\lambda$ is the penalization parameter: the larger the value of $\lambda$, the fewer number of variables will be selected.

The default initial $\lambda$ is **lambdaIni = 1**. When $\lambda = 1$, there is no microbial variable will be selected.

```{r}
rangLambda2(Y = CD.y, X = CD.x, numLambda = 12, lambdaIni = 0.2)
```

It provides a range of $\lambda$ values (**lambda**) and corresponding number of microbial variables selected (**numVarSelect**) according to a given number of $\lambda$s (**numLambda**).   


```{r}
CD.results_codalasso <- coda_lasso(Y = CD.y, X = CD.x, lambda = 0.19)
CD.results_codalasso$numVarSelect
CD.results_codalasso$varSelect
```

The method selects 11 genera with $\lambda = 0.19$.

## HFHS-Day1 data

The analysis on HFHS-Day1 data is similar as CD data.

```{r}
dim(HFHS.x)
class(HFHS.y)
summary(HFHS.y)
```

In HFHS-Day1 data, **Y** is also a factor with two levels (HFHS vs. Normal)

We then test a range of $\lambda$ and estimate the number of selected OTUs for each $\lambda$.

```{r}
rangLambda2(Y = HFHS.y, X = HFHS.x, numLambda = 20, lambdaIni = 0.3)
```

We specify a $\lambda$ and run the CoDA-lasso.

```{r}
HFHS.results_codalasso <- coda_lasso(Y = HFHS.y, X = HFHS.x, lambda = 0.18) 
HFHS.results_codalasso$numVarSelect
HFHS.results_codalasso$varSelect
```

The method selects 11 OTUs with $\lambda = 0.18$.

We also extract the taxonomic information of these selected OTUs.

```{r}
HFHS.tax_codalasso <- HFHS.taxonomy[which(rownames(HFHS.taxonomy) %in% 
                                            HFHS.results_codalasso$varSelect), ]
kable(HFHS.tax_codalasso[ ,2:6], booktabs = T)
```
